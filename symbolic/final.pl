l([1.9903645515441895, 1.7516443729400635, 1.6690936088562012, 1.612454891204834, 1.5499675273895264, 1.5086658000946045, 1.4746074676513672, 1.4496395587921143, 1.432081699371338, 1.4108548164367676, 1.3807717561721802, 1.3615334033966064, 1.3374600410461426, 1.320665955543518, 1.3013743162155151, 1.273522973060608, 1.2636569738388062, 1.2400397062301636, 1.2195912599563599, 1.2010552883148193, 1.18034029006958, 1.1662788391113281, 1.1537350416183472, 1.1354446411132812, 1.1282843351364136, 1.113322138786316, 1.1010658740997314, 1.0933361053466797, 1.0794261693954468, 1.0729918479919434, 1.0604326725006104, 1.04741370677948, 1.0378217697143555, 1.0277529954910278, 1.0148266553878784, 1.0109190940856934, 0.9998692274093628, 0.9965261816978455, 0.981082558631897, 0.9755663275718689, 0.9681211113929749, 0.9599789977073669, 0.9503331780433655, 0.9445310831069946, 0.9383704662322998, 0.9297019243240356, 0.9202839136123657, 0.9118420481681824, 0.9106352925300598, 0.9010021090507507, 0.893019437789917, 0.8821263909339905, 0.8790166974067688, 0.8707930445671082, 0.8582392334938049, 0.8558217883110046, 0.8475263118743896, 0.8422643542289734, 0.8350955247879028, 0.8326354026794434, 0.8291823267936707, 0.8281832933425903, 0.8183467388153076, 0.8069677948951721, 0.8062592148780823, 0.8012925982475281, 0.7892786860466003, 0.7840211987495422, 0.7805336713790894, 0.7818765640258789, 0.7740305662155151, 0.7608065605163574, 0.7649418711662292, 0.7549454569816589, 0.7529606819152832, 0.7465355396270752, 0.7447453141212463, 0.7405627965927124, 0.7393229603767395, 0.7313448190689087, 0.7210366129875183, 0.7269678711891174, 0.719090461730957, 0.7134709358215332, 0.7015490531921387, 0.7009707093238831, 0.6967756152153015, 0.6903992891311646, 0.687233567237854, 0.6850610971450806, 0.6821763515472412, 0.6749417781829834, 0.6738285422325134, 0.664284348487854, 0.6636071801185608, 0.6594386100769043, 0.6605562567710876, 0.6544797420501709, 0.649395763874054, 0.6488586068153381, 0.6458194255828857, 0.6378345489501953, 0.6365323662757874, 0.6321367621421814, 0.6246823072433472, 0.6241336464881897, 0.617911696434021, 0.6036767363548279, 0.6077305674552917, 0.6018758416175842, 0.5962690711021423, 0.6006947755813599, 0.5999494791030884, 0.5935205221176147, 0.5925332307815552, 0.5909155011177063, 0.593292236328125, 0.5896123647689819, 0.5920484662055969, 0.5930352210998535, 0.5881480574607849, 0.5859537720680237, 0.5936309099197388, 0.5850961208343506, 0.5838998556137085, 0.58291095495224, 0.5823273062705994, 0.5799456238746643, 0.5790615677833557, 0.5778957605361938, 0.5776223540306091, 0.5747137665748596, 0.5769615769386292, 0.5759375095367432, 0.5740429162979126, 0.572796106338501]).
sl([1.9903645515441895, 1.894876480102539, 1.804563331604004, 1.727719955444336, 1.6566189842224122, 1.5974377105712891, 1.5483056134033204, 1.508839191558838, 1.4781361946838378, 1.4512236433850099, 1.423042888499878, 1.3984390944585694, 1.3740474730935985, 1.3526948660735663, 1.3321666461303459, 1.3087091769024508, 1.290688295676993, 1.2704288598982612, 1.2500938199215006, 1.2304784072788282, 1.210423160395129, 1.1927654318816088, 1.1771532757763041, 1.160469821911095, 1.1475956272012224, 1.1338862318352598, 1.1207580887410484, 1.109789295383301, 1.0976440449881593, 1.0877831661896729, 1.076842968714048, 1.065071263940221, 1.0541714662498747, 1.043604077946336, 1.032093108922953, 1.0236235029880492, 1.0141217927565747, 1.0070835483330831, 0.9966831524526087, 0.9882364225003128, 0.9801902980573777, 0.9721057779173734, 0.9633967379677703, 0.9558504760234601, 0.9488584721069959, 0.9411958529938118, 0.9328310772412334, 0.924435465612013, 0.9189153963792317, 0.9117500814478393, 0.9042578239846704, 0.8954052507643984, 0.8888498294213465, 0.8816271154796511, 0.8722719626853126, 0.8656918929355895, 0.8584256605111096, 0.8519611379982551, 0.8452148927141141, 0.8401830967002457, 0.8357827887376157, 0.8327429905796055, 0.8269844898738863, 0.8189778118824006, 0.8138903730806732, 0.8088512631474152, 0.8010222323070892, 0.7942218188840704, 0.788746559882078, 0.7859985615395984, 0.7812113634099651, 0.773049442252522, 0.769806413818005, 0.7638620310834665, 0.7595014914161933, 0.754315110700546, 0.7504871920688261, 0.7465174338783807, 0.7436396444777242, 0.738721714314198, 0.731647673783526, 0.7297757527457626, 0.7255016363398403, 0.7206893561325175, 0.713033234956366, 0.7082082247033727, 0.7036351809081443, 0.6983408241973523, 0.693897921413553, 0.690363191706164, 0.6870884556425949, 0.6822297846587504, 0.6788692876882556, 0.673035312008095, 0.6692640592522814, 0.6653338795821306, 0.6634228304577134, 0.6598455950946964, 0.6556656626064394, 0.6529428402899989, 0.6500934744071536, 0.6451899042243703, 0.6417268890449371, 0.6378908382838349, 0.6326074258676397, 0.6292179141158597, 0.6246954270431242, 0.6162879507678056, 0.6128649974428001, 0.6084693351127137, 0.6035892295084851, 0.602431447937635, 0.6014386604038163, 0.5982714050893357, 0.5959761353662235, 0.5939518816668167, 0.59368802353134, 0.5920577600263968, 0.5920540424980768, 0.5924465139387876, 0.5907271313475865, 0.5888177876357614, 0.5907430365493523, 0.5884842702633516, 0.5866505044034943, 0.5851546846229926, 0.5840237332820353, 0.5823924895190868, 0.5810601208247944, 0.5797943767093542, 0.5789255676378562, 0.5772408472126576, 0.5771291391030462, 0.576652487276525, 0.5756086588850801, 0.5744836378664484]).
a([0.278219997882843, 0.31559599637985225, 0.3509656023979187, 0.3781793613433838, 0.404051619720459, 0.4249909746360779, 0.44265858100128175, 0.45788315395278933, 0.4690898982272339, 0.47926994130526734, 0.49044196585127564, 0.49952917563503296, 0.5090295151924211, 0.5166577146086168, 0.5239626196404141, 0.5321615712273027, 0.5387529478328171, 0.5470197645340409, 0.5552998571106222, 0.5613319032495276, 0.5690231533709202, 0.5761018879331967, 0.581845133728851, 0.5878350789708311, 0.5933410439111242, 0.5982686348687082, 0.6025691788155121, 0.6078855014299323, 0.6118753085407597, 0.6156051951571097, 0.6196351288511628, 0.623949088976042, 0.6276414622814992, 0.632456888553592, 0.6363061367256, 0.6395756780375572, 0.6422094094317873, 0.6443656437135767, 0.6486113877616544, 0.6519508368684184, 0.655858493263324, 0.657619104632616, 0.661035457759428, 0.6637572762425709, 0.6654863546524028, 0.6689318055053699, 0.6722070714318841, 0.6751002514650875, 0.6774361398393185, 0.6797176758393211, 0.6826465940442421, 0.6849559555033886, 0.6881415849673774, 0.6906849626152531, 0.6943229725032338, 0.6969777756970696, 0.6990186699653609, 0.7015952067628468, 0.7035731194648126, 0.705471880330621, 0.7071791214310996, 0.708795483265154, 0.7106852861367657, 0.7141391713692542, 0.7164194988771555, 0.7177237038352655, 0.7202902176701168, 0.7223981343938791, 0.723422892286413, 0.7257337375843722, 0.727320254109156, 0.7301601530682158, 0.7312960840208, 0.7334256539906661, 0.735175393233633, 0.736073244935236, 0.7375399525916347, 0.7385719690296513, 0.7395991846068777, 0.7418395021047639, 0.7442396961740522, 0.7448798229153077, 0.7470078831824732, 0.7481087187476798, 0.7505132281510738, 0.7521399452524606, 0.7538199778936638, 0.7552839968527755, 0.756514409418428, 0.7586366529676462, 0.7592859861500945, 0.7617075799255304, 0.7620405410736044, 0.7643763336544775, 0.766353804648253, 0.7672762863518789, 0.7682777638841864, 0.7694146630531071, 0.7716567991593789, 0.7722580718051977, 0.773210852566456, 0.7752705152172419, 0.7760583004557235, 0.7774989748718228, 0.7793233957720926, 0.7806420425673205, 0.7816412270128654, 0.7849287402665572, 0.786477244617698, 0.7872303466332897, 0.7884821975429621, 0.7895293285965781, 0.7897415906500733, 0.7902529448456714, 0.7910797721259087, 0.7920238570041829, 0.7926223037044628, 0.7931013916373506, 0.7928608426118049, 0.793724499265203, 0.7936187041520173, 0.7946352155637202, 0.7939571375627195, 0.7940302750455662, 0.7938821590535238, 0.7943212912435766, 0.7962807849619054, 0.7956884643777169, 0.7968050683345769, 0.7961310413364395, 0.7965986172487631, 0.7968471670228419, 0.7971803083466397, 0.7977481922177616, 0.7983209038179007, 0.7986565437555841]).
sa([0.278219997882843, 0.3716599941253662, 0.4040200114250183, 0.4189999997615814, 0.4428600072860718, 0.4564000070095062, 0.4691599905490875, 0.48072001338005066, 0.48590001463890076, 0.4945400059223175, 0.5072000026702881, 0.513159990310669, 0.5232800245285034, 0.5281000137329102, 0.5349199771881104, 0.5444599986076355, 0.5486400127410889, 0.5594199895858765, 0.5677199959754944, 0.5703799724578857, 0.580560028553009, 0.5867199897766113, 0.5904600024223328, 0.5968199968338013, 0.6015999913215637, 0.6056600213050842, 0.6090199947357178, 0.6158599853515625, 0.6178600192070007, 0.6212000250816345, 0.6256800293922424, 0.6304200291633606, 0.6331800222396851, 0.639680027961731, 0.6420800089836121, 0.6444799900054932, 0.6461600065231323, 0.647599995136261, 0.6549800038337708, 0.6569600105285645, 0.6617199778556824, 0.660260021686554, 0.666159987449646, 0.6678400039672852, 0.6680799722671509, 0.6740999817848206, 0.6771199703216553, 0.6794400215148926, 0.6809399724006653, 0.683139979839325, 0.6870399713516235, 0.6884199976921082, 0.6929200291633606, 0.6945000290870667, 0.6997799873352051, 0.7009599804878235, 0.7020800113677979, 0.7054600119590759, 0.7065399885177612, 0.7083200216293335, 0.7097399830818176, 0.7112200260162354, 0.7135199904441833, 0.7193199992179871, 0.7198399901390076, 0.7196800112724304, 0.7241399884223938, 0.7255600094795227, 0.7249600291252136, 0.729200005531311, 0.7297000288963318, 0.7344200015068054, 0.7329999804496765, 0.7366200089454651, 0.7378000020980835, 0.7374200224876404, 0.7397400140762329, 0.740119993686676, 0.7411400079727173, 0.745199978351593, 0.7478399872779846, 0.7458400130271912, 0.7501999735832214, 0.7497599720954895, 0.7541199922561646, 0.754580020904541, 0.7563400268554688, 0.7574800252914429, 0.7583600282669067, 0.7618200182914734, 0.7602599859237671, 0.7653399705886841, 0.7625399827957153, 0.7678800225257874, 0.769320011138916, 0.7686600089073181, 0.7697799801826477, 0.771120011806488, 0.7750200033187866, 0.7731599807739258, 0.7746400237083435, 0.7783600091934204, 0.777239978313446, 0.7796599864959717, 0.7820600271224976, 0.7826200127601624, 0.7831400036811829, 0.7898600101470947, 0.7888000011444092, 0.7883599996566772, 0.7903599739074707, 0.791100025177002, 0.7900599837303162, 0.7910199761390686, 0.7923200130462646, 0.7934399843215942, 0.7935199737548828, 0.7938200235366821, 0.7925000190734863, 0.7950199842453003, 0.7934600114822388, 0.7961599826812744, 0.7929400205612183, 0.7941399812698364, 0.7936599850654602, 0.794979989528656, 0.7992200255393982, 0.7947999835014343, 0.7984799742698669, 0.7951200008392334, 0.7972999811172485, 0.79721999168396, 0.7976800203323364, 0.7986000180244446, 0.7991799712181091, 0.7991600036621094]).
vl([1.7583093643188477, 1.638182282447815, 1.5640158653259277, 1.4975897073745728, 1.476514220237732, 1.3843004703521729, 1.412261724472046, 1.362114429473877, 1.320701003074646, 1.2913851737976074, 1.3231960535049438, 1.249393105506897, 1.219007968902588, 1.2416160106658936, 1.1990885734558105, 1.1605604887008667, 1.1367743015289307, 1.1034729480743408, 1.0897035598754883, 1.0876829624176025, 1.0736585855484009, 1.0426113605499268, 1.0550353527069092, 1.0456066131591797, 1.0172051191329956, 1.023531436920166, 1.0280197858810425, 0.9861294627189636, 0.9994031190872192, 0.9478820562362671, 0.9574764370918274, 0.9802048802375793, 0.9392164349555969, 0.9369696378707886, 0.9263113141059875, 0.8931693434715271, 0.9139890670776367, 0.8847152590751648, 0.8790847659111023, 0.8853320479393005, 0.8627844452857971, 0.8734031319618225, 0.8580836057662964, 0.8435950875282288, 0.8657369017601013, 0.864305853843689, 0.8299379944801331, 0.8292363286018372, 0.8489805459976196, 0.8174915909767151, 0.8113004565238953, 0.7920344471931458, 0.7876383066177368, 0.7872340679168701, 0.8034154176712036, 0.8044037818908691, 0.7858416438102722, 0.771239697933197, 0.7775242924690247, 0.7664023637771606, 0.7617606520652771, 0.746376097202301, 0.7506300806999207, 0.7454227805137634, 0.7335278391838074, 0.7289602756500244, 0.7320452928543091, 0.7306075096130371, 0.7210335731506348, 0.7069925665855408, 0.7243631482124329, 0.7094569802284241, 0.6991863250732422, 0.7048674821853638, 0.7041521072387695, 0.7001687288284302, 0.6948643326759338, 0.6749531626701355, 0.6771743893623352, 0.6752702593803406, 0.6829748749732971, 0.6690847277641296, 0.6729548573493958, 0.6605290770530701, 0.662114679813385, 0.6722241640090942, 0.6471782326698303, 0.6446354985237122, 0.6479204893112183, 0.6537898182868958, 0.6457415819168091, 0.6379289031028748, 0.6367046236991882, 0.617538571357727, 0.6303851008415222, 0.6416367888450623, 0.6335254907608032, 0.6336597204208374, 0.6145114302635193, 0.6134947538375854, 0.6220755577087402, 0.604375422000885, 0.614768385887146, 0.621025800704956, 0.6096389889717102, 0.6126548051834106, 0.6056500673294067, 0.5924453139305115, 0.5925142765045166, 0.589888870716095, 0.5899679064750671, 0.5971634984016418, 0.594647228717804, 0.5881100296974182, 0.5888959765434265, 0.5919584631919861, 0.5906111598014832, 0.5943411588668823, 0.5862410664558411, 0.5853304266929626, 0.5793632864952087, 0.580947995185852, 0.5800784230232239, 0.5829642415046692, 0.5796295404434204, 0.5851805806159973, 0.5800341367721558, 0.5844253301620483, 0.5807427167892456, 0.5785664319992065, 0.5727232098579407, 0.5857605338096619, 0.5839062929153442, 0.5792896151542664, 0.5766827464103699, 0.5772711038589478]).
va([0.37779998779296875, 0.41990000009536743, 0.44179999828338623, 0.4659000039100647, 0.46380001306533813, 0.5026999711990356, 0.4948999881744385, 0.512499988079071, 0.5220999717712402, 0.541100025177002, 0.5242000222206116, 0.5569000244140625, 0.5631999969482422, 0.5580999851226807, 0.5713000297546387, 0.586899995803833, 0.5964000225067139, 0.6104000210762024, 0.6158999800682068, 0.6154999732971191, 0.6258999705314636, 0.633899986743927, 0.6272000074386597, 0.6335999965667725, 0.642300009727478, 0.6395000219345093, 0.6427000164985657, 0.6567000150680542, 0.6517000198364258, 0.6726999878883362, 0.6679999828338623, 0.6583999991416931, 0.6733999848365784, 0.6764000058174133, 0.6776999831199646, 0.691100001335144, 0.6822999715805054, 0.6947000026702881, 0.6952999830245972, 0.6934000253677368, 0.7016000151634216, 0.6963000297546387, 0.7050999999046326, 0.7070000171661377, 0.7020000219345093, 0.7003999948501587, 0.7114999890327454, 0.7106000185012817, 0.7070000171661377, 0.7145000100135803, 0.7206000089645386, 0.7228999733924866, 0.7253999710083008, 0.7283999919891357, 0.7214000225067139, 0.7245000004768372, 0.7301999926567078, 0.734499990940094, 0.7305999994277954, 0.7340999841690063, 0.7330999970436096, 0.7412999868392944, 0.7408999800682068, 0.7448999881744385, 0.7465999722480774, 0.7487000226974487, 0.746999979019165, 0.7487999796867371, 0.7537000179290771, 0.7585999965667725, 0.7505000233650208, 0.7555999755859375, 0.760200023651123, 0.7610999941825867, 0.7572000026702881, 0.7577000260353088, 0.7630000114440918, 0.7681000232696533, 0.7662000060081482, 0.7680000066757202, 0.7681000232696533, 0.767799973487854, 0.7674000263214111, 0.7764000296592712, 0.7721999883651733, 0.7713000178337097, 0.7771999835968018, 0.7767000198364258, 0.777999997138977, 0.7760000228881836, 0.7818999886512756, 0.7818999886512756, 0.78329998254776, 0.7901999950408936, 0.7840999960899353, 0.7839000225067139, 0.7831000089645386, 0.7860999703407288, 0.7885000109672546, 0.7901999950408936, 0.7875000238418579, 0.7950000166893005, 0.7900999784469604, 0.786300003528595, 0.794700026512146, 0.7912999987602234, 0.7936000227928162, 0.7979000210762024, 0.8008999824523926, 0.800599992275238, 0.798799991607666, 0.7982000112533569, 0.7980999946594238, 0.800599992275238, 0.801800012588501, 0.8001999855041504, 0.7980999946594238, 0.7990999817848206, 0.8004999756813049, 0.8008000254631042, 0.8029999732971191, 0.8030999898910522, 0.8001000285148621, 0.8016999959945679, 0.8044999837875366, 0.8015999794006348, 0.8026000261306763, 0.8011999726295471, 0.8026999831199646, 0.8025000095367432, 0.8065000176429749, 0.7993999719619751, 0.8019999861717224, 0.8029999732971191, 0.8029999732971191, 0.8033000230789185]).
int_loss(109.64443957805634).
int_slope(157.6516816020012).
lacc(0.125).
hloss(0.75).
flops(50469750).
flops_th(77479996).
nparams(1311139.0).
nparams_th(23851784).

0.99::eve.
action(reg_l2,overfitting) :- eve, problem(overfitting).
action(decr_lr,inc_loss) :- eve, problem(inc_loss).
action(decr_lr,high_lr) :- eve, problem(high_lr).
action(inc_lr,low_lr) :- eve, problem(low_lr).
0.4::action(inc_dropout,overfitting):- problem(overfitting).
0.0::action(data_augmentation,overfitting):- problem(overfitting).
0.3::action(decr_lr,underfitting):- problem(underfitting).
0.333333333333333::action(inc_neurons,underfitting):- problem(underfitting).
0.75::action(new_fc_layer,underfitting):- problem(underfitting).
0.45::action(new_conv_layer,underfitting):- problem(underfitting).
0.6::action(inc_batch_size,floating_loss):- problem(floating_loss).
0.15::action(decr_lr,floating_loss):- problem(floating_loss).
0.4::action(dec_neurons,latency):- problem(latency).
0.5::action(dec_layers,latency):- problem(latency).
0.4::action(dec_neurons,model_size):- problem(model_size).
0.5::action(dec_layers,model_size):- problem(model_size).

% DIAGNOSIS SECTION ----------------------------------------------------------------------------------------------------
:- use_module(library(lists)).

% UTILITY
abs2(X,Y) :- Y is abs(X).
isclose(X,Y,W) :- D is X - Y, abs2(D,D1), D1 =< W.

add_to_UpList([_],0).
add_to_UpList([H|[H1|T]], U) :- add_to_UpList([H1|T], U1), H =< H1, U is U1+1.
add_to_UpList([H|[H1|T]], U) :- add_to_UpList([H1|T], U1), H > H1, U is U1+0.

add_to_DownList([_],0).
add_to_DownList([H|[H1|T]], U) :- add_to_DownList([H1|T], U1), H > H1, U is U1+1.
add_to_DownList([H|[H1|T]], U) :- add_to_DownList([H1|T], U1), H =< H1, U is U1+0.

area_sub(R) :- int_loss(A), int_slope(B), Rt is A - B, abs2(Rt,R).
threshold_up(Th) :- int_slope(A), Th is A/4.
threshold_down(Th) :- int_slope(A), Th is A*(3/4).

% ANALYSIS
gap_tr_te_acc :- a(A), va(VA), last(A,LTA), last(VA,ScoreA),
                Res is LTA - ScoreA, abs2(Res,Res1), Res1 > 0.2.
gap_tr_te_loss :- l(L), vl(VL), last(L,LTL), last(VL,ScoreL),
                Res is LTL - ScoreL, abs2(Res,Res1), Res1 > 0.2.
low_acc :- va(A), lacc(Tha), last(A,LTA),
                Res is LTA - 1.0, abs2(Res,Res1), Res1 > Tha.
high_loss :- vl(L), hloss(Thl), last(L,LTL), \+isclose(LTL,0,Thl).
growing_loss_trend :- l(L),add_to_UpList(L,Usl), length(L,Length_u), G is (Usl*100)/Length_u, G > 50.
up_down_acc :- a(A),add_to_UpList(A,Usa), add_to_DownList(A,Dsa), isclose(Usa,Dsa,150), Usa > 0, Dsa > 0.
up_down_loss :- l(L),add_to_UpList(L,Usl), add_to_DownList(L,Dsl), isclose(Usl,Dsl,150), Usl > 0, Dsl > 0.
to_low_lr :- area_sub(As), threshold_up(Th), As < Th.
to_high_lr :- area_sub(As), threshold_down(Th), As > Th.

% utils for hardware constraints
high_flops :- flops(V), flops_th(Th), V > Th.
high_numb_params :- nparams(V), nparams_th(Th), V > Th.


% POSSIBLE PROBLEMS
problem(overfitting) :- gap_tr_te_acc; gap_tr_te_loss.
problem(underfitting) :- low_acc; high_loss.
problem(inc_loss) :- growing_loss_trend.
problem(floating_loss) :- up_down_loss.
problem(low_lr) :- to_low_lr.
problem(high_lr) :- to_high_lr.

% rules for hardware constraints
problem(latency) :- high_flops.
problem(model_size) :- high_numb_params.

% QUERY ----------------------------------------------------------------------------------------------------------------
query(action(_,_)).